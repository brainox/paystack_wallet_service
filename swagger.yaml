openapi: 3.0.3
info:
  title: Paystack Wallet Service API
  description: |
    Backend wallet service with Paystack integration, JWT authentication, and API key management.
    
    ## üöÄ Quick Start Guide
    
    ### Step 1: Get Your JWT Token
    **IMPORTANT**: The Google sign-in must be done in your browser, not from Swagger UI.
    
    1. **Open this link in a new tab**: [https://pure-plateau-79480-6fc7adb7399c.herokuapp.com/auth/google](https://pure-plateau-79480-6fc7adb7399c.herokuapp.com/auth/google)
    2. Sign in with your Google account
    3. Copy the JWT token from the JSON response: `{"token": "eyJ..."}`
    4. Click the **"Authorize"** button at the top of this page
    5. Paste your token in the "Value" field (Bearer will be added automatically)
    6. Click "Authorize" and close the dialog
    
    ### Step 2: Test the API
    Now you can test all protected endpoints! Try:
    - `GET /wallet/balance` - Check your wallet balance
    - `POST /keys/create` - Create an API key
    - `GET /wallet/info` - Get your wallet details
    
    ## Authentication Methods
    - **JWT**: Use `Authorization: Bearer <token>` header (obtained from Google OAuth)
    - **API Key**: Use `x-api-key: <key>` header (obtained from `/keys/create`)
    
    ## Live API
    Base URL: https://pure-plateau-79480-6fc7adb7399c.herokuapp.com
  version: 1.0.0
  contact:
    name: API Support
    url: https://github.com/brainox/paystack_wallet_service

servers:
  - url: https://pure-plateau-79480-6fc7adb7399c.herokuapp.com
    description: Production server (Heroku)
  - url: http://localhost:8080
    description: Local development server

tags:
  - name: Authentication
    description: Google OAuth and JWT token generation
  - name: API Keys
    description: Service-to-service authentication management
  - name: Wallet
    description: Wallet operations (deposits, transfers, balance)
  - name: Health
    description: Health check endpoint

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health Check
      description: Check if the API is running
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /auth/google:
    get:
      tags:
        - Authentication
      summary: Initiate Google Sign-In
      description: |
        ‚ö†Ô∏è **IMPORTANT**: This endpoint must be opened directly in your browser, not executed from Swagger UI.
        
        **How to use:**
        1. Open this URL in a new browser tab: `https://pure-plateau-79480-6fc7adb7399c.herokuapp.com/auth/google`
        2. Sign in with your Google account
        3. You'll be redirected to the callback URL with a JWT token in the response
        4. Copy the token from the JSON response
        5. Use "Authorize" button above to set the Bearer token for other endpoints
        
        This endpoint redirects to Google OAuth consent screen and cannot be tested via AJAX/fetch from Swagger UI due to browser security (CORS).
      responses:
        '302':
          description: Redirect to Google OAuth

  /auth/google/callback:
    get:
      tags:
        - Authentication
      summary: Google OAuth Callback
      description: |
        ‚ÑπÔ∏è **NOTE**: This is an automatic callback endpoint handled by Google OAuth flow. You don't call this directly.
        
        After signing in at `/auth/google`, Google automatically redirects to this endpoint and you'll see a JSON response with your JWT token.
        
        **Example response:**
        ```json
        {
          "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        }
        ```
        
        Copy this token and use the "Authorize" button above to authenticate other API requests.
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
          description: Authorization code from Google (automatically provided)
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

  /keys/create:
    post:
      tags:
        - API Keys
      summary: Create API Key
      description: |
        Create a new API key with specific permissions.
        - Maximum 5 active keys per user
        - Expiry options: 1H, 1D, 1M, 1Y
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - permissions
                - expiry
              properties:
                name:
                  type: string
                  example: wallet-service
                permissions:
                  type: array
                  items:
                    type: string
                    enum: [deposit, transfer, read]
                  example: ["deposit", "transfer", "read"]
                expiry:
                  type: string
                  enum: ["1H", "1D", "1M", "1Y"]
                  example: 1D
      responses:
        '200':
          description: API key created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  api_key:
                    type: string
                    example: sk_live_xxxxxxxxxxxxx
                  expires_at:
                    type: string
                    format: date-time
                    example: 2025-12-11T12:00:00Z
        '400':
          description: Bad request (max keys reached, invalid expiry, etc.)

  /keys/rollover:
    post:
      tags:
        - API Keys
      summary: Rollover Expired API Key
      description: Create a new API key using the same permissions as an expired key
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - expired_key_id
                - expiry
              properties:
                expired_key_id:
                  type: string
                  example: FGH2485K6KK79GKG9GKGK
                expiry:
                  type: string
                  enum: ["1H", "1D", "1M", "1Y"]
                  example: 1M
      responses:
        '200':
          description: API key rolled over successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  api_key:
                    type: string
                    example: sk_live_xxxxxxxxxxxxx
                  expires_at:
                    type: string
                    format: date-time
                    example: 2026-01-11T12:00:00Z

  /keys/list:
    get:
      tags:
        - API Keys
      summary: List API Keys
      description: Get all API keys for the authenticated user
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of API keys
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    name:
                      type: string
                    key_prefix:
                      type: string
                    permissions:
                      type: array
                      items:
                        type: string
                    expires_at:
                      type: string
                      format: date-time
                    is_active:
                      type: boolean
                    created_at:
                      type: string
                      format: date-time

  /keys/{id}:
    delete:
      tags:
        - API Keys
      summary: Delete API Key
      description: Revoke an API key
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: API key ID
      responses:
        '200':
          description: API key deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: API key deleted successfully

  /wallet/deposit:
    post:
      tags:
        - Wallet
      summary: Initiate Deposit
      description: Initialize a Paystack deposit transaction
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - amount
              properties:
                amount:
                  type: number
                  format: float
                  minimum: 1
                  example: 5000
      responses:
        '200':
          description: Deposit initialized successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  reference:
                    type: string
                    example: DEP_xxxxx_123456789
                  authorization_url:
                    type: string
                    example: https://checkout.paystack.com/xxxxx

  /wallet/paystack/webhook:
    post:
      tags:
        - Wallet
      summary: Paystack Webhook
      description: |
        Receives transaction updates from Paystack.
        **MANDATORY**: This is the only endpoint that credits wallets.
        Validates Paystack signature before processing.
      parameters:
        - name: x-paystack-signature
          in: header
          required: true
          schema:
            type: string
          description: Paystack webhook signature
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Paystack webhook payload
      responses:
        '200':
          description: Webhook processed
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: boolean
                    example: true

  /wallet/deposit/{reference}/status:
    get:
      tags:
        - Wallet
      summary: Check Deposit Status
      description: Get the status of a deposit transaction (does NOT credit wallet)
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: reference
          in: path
          required: true
          schema:
            type: string
          description: Transaction reference
      responses:
        '200':
          description: Deposit status
          content:
            application/json:
              schema:
                type: object
                properties:
                  reference:
                    type: string
                    example: DEP_xxxxx_123456789
                  status:
                    type: string
                    enum: [success, failed, pending]
                    example: success
                  amount:
                    type: number
                    example: 5000

  /wallet/balance:
    get:
      tags:
        - Wallet
      summary: Get Wallet Balance
      description: Retrieve current wallet balance
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      responses:
        '200':
          description: Wallet balance
          content:
            application/json:
              schema:
                type: object
                properties:
                  balance:
                    type: number
                    format: float
                    example: 15000

  /wallet/info:
    get:
      tags:
        - Wallet
      summary: Get Wallet Information
      description: Get detailed wallet information including wallet number
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      responses:
        '200':
          description: Wallet information
          content:
            application/json:
              schema:
                type: object
                properties:
                  wallet_number:
                    type: string
                    example: "9740068256318"
                  balance:
                    type: number
                    example: 15000
                  created_at:
                    type: string
                    format: date-time

  /wallet/transfer:
    post:
      tags:
        - Wallet
      summary: Transfer Funds
      description: Transfer money to another user's wallet
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - wallet_number
                - amount
              properties:
                wallet_number:
                  type: string
                  example: "4566678954356"
                amount:
                  type: number
                  format: float
                  minimum: 1
                  example: 3000
      responses:
        '200':
          description: Transfer successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  message:
                    type: string
                    example: Transfer completed
        '400':
          description: Bad request (insufficient balance, invalid wallet, etc.)

  /wallet/transactions:
    get:
      tags:
        - Wallet
      summary: Get Transaction History
      description: Retrieve transaction history for the wallet
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
          description: Number of transactions to return
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Number of transactions to skip
      responses:
        '200':
          description: Transaction history
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                      enum: [deposit, debit, credit]
                      example: deposit
                    amount:
                      type: number
                      example: 5000
                    status:
                      type: string
                      enum: [success, failed, pending]
                      example: success

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from Google OAuth callback
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key
      description: API key for service-to-service access (requires specific permissions)

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          example: Error message description
